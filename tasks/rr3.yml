---

- name: 'Clone the rr3 repo'
  git:
    repo: 'https://github.com/Edugate/Jagger'
    dest: '{{ install.dir }}'

- name: 'Have composer install additional libraries'
  command: '/usr/local/bin/composer install'
  args:
    chdir: '{{ install.dir }}/application'
    creates: '{{ install.dir }}/application/composer.lock'

- name: 'Copy in the index.php file'
  copy:
    dest: '{{ install.dir }}/index.php'
    src: '{{ install_base }}/codeigniter/index.php'
    owner: root
    group: root
    mode: 0644
    remote_src: yes

- name: 'Fix $system_path in index.php'
  replace:
    path: '{{ install.dir }}/index.php'
    regexp: "system_path = 'system';"
    replace: "system_path = '{{ install_base}}/codeigniter/system';"

- name: 'Run the install script'
  command: '/opt/rr3/install.sh'
  args:
    chdir: /opt/rr3
    creates: /opt/rr3/logos2

- name: 'Check if composer has run'
  stat:
    path: /opt/rr3/application/composer.done
  register: composer_done

- name: 'Remove composer.lock to ensure composer runs'
  file:
    path: /opt/rr3/application/composer.lock
    state: absent
  when: composer_done.stat.exists == False

- name: 'Run composer'
  command: '/usr/local/bin/composer install'
  args:
    chdir: /opt/rr3/application
    creates: /opt/rr3/application/composer.done
  when: composer_done.stat.exists == False

- name: 'Set composer.done'
  file:
    path: /opt/rr3/application/composer.done
    state: touch
  when: composer_done.stat.exists == False

- name: 'Set main config.php file'
  template:
    src: templates/rr3/config.php
    dest: /opt/rr3/application/config/config.php
    owner: root
    group: apache
    more: 750
